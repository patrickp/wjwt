SUBROUTINE WJWT(ACTION,PARAMIN,PARAMOUT,OPTIONSOBJ,RERR)
************************************
* FUNCTION FOR MANAGING JAVASCRIPT WEB TOKENS
************************************
*
DOINGRFILE=1
OPEN "RESULT.FILE" TO RFILE ELSE DOINGRFILE=0
CALL WOBJ(OPTIONSOBJ,"GET","key",JWTKEY,"",RERR)
IF JWTKEY="" THEN
   RERR=-1
   RERR<2>="No key"
   RETURN
END
*
ACTION=OCONV(ACTION,"MCU")
*
BEGIN CASE
   CASE ACTION="SIGN"
      GOSUB signtoken
   CASE ACTION="VERIFY"
      GOSUB verifytoken
END CASE
RETURN
STOP
*
signtoken: *
*
* We should have a payload record
*
IF PARAMIN = "" THEN
   * WE ARE OK, THIS IS A BLANK AND WE AN MAKE IT A OBJECT 
   CALL WOBJ(PAYLOADOBJ,"FROMSTRING","","{}","",RERR)
END ELSE
   PAYLOADOBJ = PARAMIN
END
CALL WOBJ(OPTIONSOBJ,"GET","exp",EXPIRATION,"",RERR)
*
* LETS GET OUR CREATE DATE
*
P=DATE()
P<2>=TIME()
CALL WJWT.WUTC("TO",P,UTC,RERR)
IF NOT(UTC) THEN
   RERR=-1
   RERR<2>="Issue creating UTC date for iat"
   RETURN
END
CALL WOBJ(PAYLOADOBJ,"SET.NUMBER","iat",UTC,"",RERR)
*
* Lets get how long this token is good For *
*
CALL WOBJ(OPTIONSOBJ,"GET","expires_in",EXPIRES_IN,"",RERR)
IF EXPIRES_IN THEN
   * This should be a numeric and be the number of seconds
   EXPIRATION=UTC+EXPIRES_IN
   CALL WOBJ(PAYLOADOBJ,"GET","exp",EXPIRATION,"",RERR)
END
CALL WOBJ(PAYLOADOBJ,"TOSTRING","",PAYLOADJSON,"",RERR)
*
* lets build our header
*
CALL WOBJ(JWTHEADEROBJ,"FROMSTRING","","{}","",RERR)
CALL WOBJ(JWTHEADEROBJ,"SET.STRING","alg","HS256","",RERR)
CALL WOBJ(JWTHEADEROBJ,"SET.STRING","type","JWT","",RERR)
CALL WOBJ(JWTHEADEROBJ,"TOSTRING","",JWTHEADERJSON,"",RERR)
*
* now we need to create our token, this needs to be options later, for now we will code header
*
CALL WJWT.WENCRYPTION("TOBASE64",JWTHEADERJSON,JWTHEADERJSONBASE64,'',RERR)
CALL WJWT.WENCRYPTION("TOBASE64",PAYLOADJSON,PAYLOADJSONBASE64,'',RERR)
JWT=JWTHEADERJSONBASE64:".":PAYLOADJSONBASE64
CALL WJWT.WENCRYPTION("TOH256",JWT,JWTSIGNED,'',RERR)
PARAMOUT=JWT:".":JWTSIGNED
*
RETURN
*
verifytoken: *
HEADER=FIELD(PARAMIN,".",1)
PAYLOAD=FIELD(PARAMIN,".",2)
SIGN=FIELD(PARAMIN,".",3)
JWT=HEADER:".":PAYLOAD
CALL WJWT.WENCRYPTION("TOH256",JWT,JWTSIGNED,"",RERR)
IF SIGN = JWTSIGNED THEN PRINT "OK" ELSE PRINT "BAD"
PARAMOUT=0
IF SIGN = JWTSIGNED THEN PARAMOUT=1
RETURN
